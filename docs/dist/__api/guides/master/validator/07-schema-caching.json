{"type":"root","children":[{"type":"element","tag":"dimertitle","props":{},"children":[{"type":"text","value":"Schema Caching"}]},{"type":"element","tag":"h1","props":{"id":"schema-caching"},"children":[{"type":"element","tag":"a","props":{"href":"#schema-caching","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Schema Caching"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The schema created using "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"schema.create"}]},{"type":"text","value":" method is first complied to an executable function and then executed to validate the data against the defined rules."}]},{"type":"element","tag":"div","props":{"className":["toc-container"]},"children":[{"type":"element","tag":"h2","props":{},"children":[{"type":"text","value":"Table of contents"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#using-the-cachekey"},"children":[{"type":"text","value":"Using the cacheKey"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#caching-caveats"},"children":[{"type":"text","value":"Caching caveats"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#option-1-give-up-caching"},"children":[{"type":"text","value":"Option 1 (Give up caching)"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#option-2-create-a-unique-key"},"children":[{"type":"text","value":"Option 2 (Create a unique key)"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#option-3-using-refs"},"children":[{"type":"text","value":"Option 3 (Using refs)"}]}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The compilation process does takes some time "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"(1ms to 2ms)"}]},{"type":"text","value":" before the validation begins. Based upon the performance expectations you have, you may want to consider caching the compiled schema and hence don't pay the compilation penalty on every request."}]},{"type":"element","tag":"h2","props":{"id":"using-the-cachekey"},"children":[{"type":"element","tag":"a","props":{"href":"#using-the-cachekey","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Using the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"cacheKey"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Caching a schema is straightforward, you just need to define a unique "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"cacheKey"}]},{"type":"text","value":" during the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"request.validate"}]},{"type":"text","value":" call."}]},{"type":"element","tag":"div","props":{"className":["alert","alert-note"]},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It is recommended to use "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"ctx.routeKey"}]},{"type":"text","value":" over "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"request.url()"}]},{"type":"text","value":" as the cache key. Since, your application can have two same URLs using different HTTP methods and hence their schemas will conflict."}]}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token keyword\">await</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  schema<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  cacheKey<span class=\"token operator\">:</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The first call to "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"request.validate"}]},{"type":"text","value":" will compile the schema and saves the output in reference to the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"cacheKey"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Until the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"cacheKey"}]},{"type":"text","value":" is same, the schema won't be compiled again."}]}]},{"type":"element","tag":"h2","props":{"id":"caching-caveats"},"children":[{"type":"element","tag":"a","props":{"href":"#caching-caveats","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Caching caveats"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Caching in any form is not free and same is the case with the schema caching. If your schema relies on runtime values, then caching schema will not give desired outcome. Consider the following example:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"You are creating a form that accepts the user "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"state"}]},{"type":"text","value":" and their "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"city"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The city options are based upon the value of the selected "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"state"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token comment\">/**\n * Assuming following variables holds data\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">STATES</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CITIES</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AddressValidator</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> selectedState <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// ðŸ‘ˆ</span>\n\n  <span class=\"token keyword\">public</span> schema <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    state<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">enum</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STATES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">enum</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CITIES</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selectedState<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you look at the above example, the enum options for the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"city"}]},{"type":"text","value":" are dependent on the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"selectedState"}]},{"type":"text","value":" and will vary with every HTTP request. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Hence, there is no simple way to cache the schema with a fixed key"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"option-1-give-up-caching"},"children":[{"type":"element","tag":"a","props":{"href":"#option-1-give-up-caching","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Option 1 (Give up caching)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first option is to give up caching. This will add a delay of couple of milliseconds to your requests, but gives you the simplest API to use to runtime values within your schema definition."}]},{"type":"element","tag":"h3","props":{"id":"option-2-create-a-unique-key"},"children":[{"type":"element","tag":"a","props":{"href":"#option-2-create-a-unique-key","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Option 2 (Create a unique key)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Considering the above example, you can append the selected state to the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"cacheKey"}]},{"type":"text","value":" and hence each state will have its own copy of cache schema. For example:"}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AddressValidator</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> selectedState <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">public</span> schema <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    state<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">enum</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STATES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">enum</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CITIES</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selectedState<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"dimer-highlight-code-line\">  <span class=\"token keyword\">public</span> cacheKey <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>routeKey<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>selectedState<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span></span><span class=\"token punctuation\">}</span>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The above approach has its own set of downsides. If there are 37 states, then there will be 37 cached copies of the same schema with a small variation. Also, this number will grow exponentially if you need more than one dynamic value."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In fact, giving up caching is better than caching too many schemas with small variations."}]},{"type":"element","tag":"h3","props":{"id":"option-3-using-refs"},"children":[{"type":"element","tag":"a","props":{"href":"#option-3-using-refs","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Option 3 (Using refs)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Refs gives you the best of the both worlds. You can still cache your schema and also reference the runtime values inside them. Following is an example of the same:"}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AddressValidator</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> selectedState <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"dimer-highlight-code-line\">  <span class=\"token keyword\">public</span> refs <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">refs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"dimer-highlight-code-line\">    cities<span class=\"token operator\">:</span> <span class=\"token constant\">CITIES</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selectedState<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"dimer-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">public</span> schema <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    state<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">enum</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STATES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">enum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refs<span class=\"token punctuation\">.</span>cities<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Instead of referencing "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"CITIES[this.selectedState]"}]},{"type":"text","value":" directly, you move it to the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"schema.refs"}]},{"type":"text","value":" object and from there on, the cities will be picked up at runtime without re-compiling the schema."}]},{"type":"element","tag":"div","props":{"className":["alert","alert-note"]},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Refs only work if the "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"validation rule"}]},{"type":"text","value":" or the "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"schema type"}]},{"type":"text","value":" supports them."}]}]}]}
