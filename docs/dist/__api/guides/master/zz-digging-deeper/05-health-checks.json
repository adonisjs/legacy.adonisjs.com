{"type":"root","children":[{"type":"element","tag":"dimertitle","props":{},"children":[{"type":"text","value":"Health Checks"}]},{"type":"element","tag":"h1","props":{"id":"health-checks"},"children":[{"type":"element","tag":"a","props":{"href":"#health-checks","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Health Checks"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the era of Containers and Orchestration, it is very important for your application to report about its own health. For example, Kubernetes can use the health checks information for its "},{"type":"element","tag":"a","props":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/"},"children":[{"type":"text","value":"liveness and readiness probes"}]},{"type":"text","value":"."}]},{"type":"element","tag":"div","props":{"className":["toc-container"]},"children":[{"type":"element","tag":"h2","props":{},"children":[{"type":"text","value":"Table of contents"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#how-health-checks-works"},"children":[{"type":"text","value":"How Health Checks Works?"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#existing-health-checkers"},"children":[{"type":"text","value":"Existing Health checkers"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#app-key-checker"},"children":[{"type":"text","value":"App Key Checker"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#node_env-checker"},"children":[{"type":"text","value":"NODE_ENV Checker"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#sql-database-checker"},"children":[{"type":"text","value":"SQL Database Checker"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#redis-checker"},"children":[{"type":"text","value":"Redis Checker"}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#un-healthy-report-sample"},"children":[{"type":"text","value":"Un-healthy report sample"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#healthy-report-sample"},"children":[{"type":"text","value":"Healthy report sample"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"#registering-your-own-checker"},"children":[{"type":"text","value":"Registering your own checker"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"how-health-checks-works"},"children":[{"type":"element","tag":"a","props":{"href":"#how-health-checks-works","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"How Health Checks Works?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"AdonisJS exposes a unified module for health checks. The other parts of the application, including the packages you install, can register checkers to this module. For example: "},{"type":"element","tag":"a","props":{"href":"https://github.com/adonisjs/lucid/blob/develop/providers/DatabaseProvider.ts#L73"},"children":[{"type":"text","value":"Lucid registers"}]},{"type":"text","value":" a checker for reporting its connectivity with the database."}]},{"type":"element","tag":"div","props":{"className":["alert","alert-note"]},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can make use of "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"HealthCheck.getReport"}]},{"type":"text","value":" method to get the health check report and then share it with the external services. If any of the registered checkers fails, your application will be considered unhealthy."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Coming back to the Kubernetes example, you can expose the health of your application to Kubernetes using an HTTP route. The following code example is copied (with some modifications) from the "},{"type":"element","tag":"a","props":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-http-request"},"children":[{"type":"text","value":"K8 official documentation"}]},{"type":"text","value":"."}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-yaml","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>adonis<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>docker<span class=\"token punctuation\">-</span>service/app\n    <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n        <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n      <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n      <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"As you can notice, the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"livenessProbe"}]},{"type":"text","value":" relies on the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"/healthz"}]},{"type":"text","value":" route to know the health of the application. If your app will respond with anything other than a "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"200"}]},{"type":"text","value":", then Kubernetes will consider it as unstable."}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token keyword\">import</span> Route <span class=\"token keyword\">from</span> <span class=\"token string\">'@ioc:Adonis/Core/Route'</span>\n<span class=\"token keyword\">import</span> HealthCheck <span class=\"token keyword\">from</span> <span class=\"token string\">'@ioc:Adonis/Core/HealthCheck'</span>\n\nRoute<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/healthz'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> response <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"dimer-highlight-code-line\">  <span class=\"token keyword\">const</span> isLive <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> HealthCheck<span class=\"token punctuation\">.</span><span class=\"token function\">isLive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">return</span> isLive\n    <span class=\"token operator\">?</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Since, Kubernetes only relies on the HTTP status, there is no need to fetch the complete report using "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"HealthCheck.getReport"}]},{"type":"text","value":". Just using "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"isLive"}]},{"type":"text","value":" method is sufficient."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Similarly, you can use the same approach with other monitoring tools like Pingdom."}]},{"type":"element","tag":"h2","props":{"id":"existing-health-checkers"},"children":[{"type":"element","tag":"a","props":{"href":"#existing-health-checkers","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Existing Health checkers"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Following is the list of pre-bundled health checkers. You can also add your own checkers, and we will explore the API for that later in this guide."}]},{"type":"element","tag":"h3","props":{"id":"app-key-checker"},"children":[{"type":"element","tag":"a","props":{"href":"#app-key-checker","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"App Key Checker"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The checker will look for the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"APP_KEY"}]},{"type":"text","value":" environment variable and fails if the key is missing or its length is less than 32 characters."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To fix the issue, you can generate a secure key using "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"node ace generate:key"}]},{"type":"text","value":" command and set the output value as "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"APP_KEY"}]},{"type":"text","value":" environment variable."}]},{"type":"element","tag":"h3","props":{"id":"node_env-checker"},"children":[{"type":"element","tag":"a","props":{"href":"#node_env-checker","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"NODE_ENV Checker"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The checker will look for the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"NODE_ENV"}]},{"type":"text","value":" environment variable and fails if no environment has been set. You should never run your apps with an undefined "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"NODE_ENV"}]},{"type":"text","value":" value."}]},{"type":"element","tag":"h3","props":{"id":"sql-database-checker"},"children":[{"type":"element","tag":"a","props":{"href":"#sql-database-checker","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"SQL Database Checker"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"@adonisjs/lucid"}]},{"type":"text","value":" package registers a checker to check the database connectivity from your application. To enable the health checks for your database, you just need to turn on the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"healthCheck"}]},{"type":"text","value":" flag inside the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"config/database.ts"}]},{"type":"text","value":" file."}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token punctuation\">{</span>\n  pg<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    client<span class=\"token operator\">:</span> <span class=\"token string\">'pg'</span><span class=\"token punctuation\">,</span>\n    connection<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    healthCheck<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ðŸ‘ˆ</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"redis-checker"},"children":[{"type":"element","tag":"a","props":{"href":"#redis-checker","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Redis Checker"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Similar to the SQL databases, you can also enable the health checks for your redis server when using the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"@adonisjs/redis"}]},{"type":"text","value":" module."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To enable the health checks for your redis server, you just need to turn on the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"healthCheck"}]},{"type":"text","value":" flag inside the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"config/redis.ts"}]},{"type":"text","value":" file."}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token punctuation\">{</span>\n  local<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    host<span class=\"token operator\">:</span> <span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token operator\">:</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    healthCheck<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// ðŸ‘ˆ</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"un-healthy-report-sample"},"children":[{"type":"element","tag":"a","props":{"href":"#un-healthy-report-sample","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Un-healthy report sample"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"src":"https://res.cloudinary.com/adonis-js/image/upload/q_auto,w_700,f_auto,fl_lossy/v1592214549/adonisjs.com/unhealthy-health-check.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"healthy-report-sample"},"children":[{"type":"element","tag":"a","props":{"href":"#healthy-report-sample","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Healthy report sample"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"src":"https://res.cloudinary.com/adonis-js/image/upload/q_auto,w_700,f_auto,fl_lossy/v1592214549/adonisjs.com/health-check-healthy.png"},"children":[]}]},{"type":"element","tag":"h2","props":{"id":"registering-your-own-checker"},"children":[{"type":"element","tag":"a","props":{"href":"#registering-your-own-checker","aria-hidden":true},"children":[{"type":"element","tag":"span","props":{"className":["icon","icon-link"]},"children":[]}]},{"type":"text","value":"Registering your own checker"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can also register your own health checkers using the Health check module. Since, the checker needs to be registered only once, you must use a "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"preload file"}]},{"type":"text","value":" or the "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"service provider"}]},{"type":"text","value":" to register it."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For demonstration, lets open the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"providers/AppProvider.ts"}]},{"type":"text","value":" and paste the following code inside the "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"boot"}]},{"type":"text","value":" method."}]},{"type":"element","tag":"div","props":{"className":["dimer-highlight"]},"children":[{"type":"element","tag":"pre","props":{"className":["language-ts","line-numbers"]},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> IocContract <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@adonisjs/fold'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AppProvider</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">protected</span> $container<span class=\"token operator\">:</span> IocContract<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"dimer-highlight-code-line\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token function\">boot</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"dimer-highlight-code-line\">    <span class=\"token keyword\">const</span> HealthCheck <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@ioc:Adonis/Core/HealthCheck'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span></span><span class=\"dimer-highlight-code-line\">&nbsp;</span><span class=\"dimer-highlight-code-line\">    HealthCheck<span class=\"token punctuation\">.</span><span class=\"token function\">addChecker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-checker'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"dimer-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span></span><span class=\"dimer-highlight-code-line\">        displayName<span class=\"token operator\">:</span> <span class=\"token string\">'Checker Name'</span><span class=\"token punctuation\">,</span></span><span class=\"dimer-highlight-code-line\">        health<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"dimer-highlight-code-line\">          healthy<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></span><span class=\"dimer-highlight-code-line\">          message<span class=\"token operator\">:</span> <span class=\"token string\">'Everything works fine'</span></span><span class=\"dimer-highlight-code-line\">        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"dimer-highlight-code-line\">        meta<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"dimer-highlight-code-line\">      <span class=\"token punctuation\">}</span></span><span class=\"dimer-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"dimer-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span>\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"HealthCheck.addChecker"}]},{"type":"text","value":" accepts a total of two arguments."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The first argument is a unique name of the checker."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The second argument is the callback that should return the report with following required properties."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"displayName"}]},{"type":"text","value":" A human readable name of the checker."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"health.healthy"}]},{"type":"text","value":" A boolean that indicates if the service is healthy."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"health.message"}]},{"type":"text","value":" Error or success message."}]}]}]}]}]}
